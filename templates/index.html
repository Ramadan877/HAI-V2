<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Chat with AI</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        body {
            display: flex;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1e293b;
            color: #ffffff;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100%;
            height: 100%;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .avatar-container {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 150px;
            height: 150px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .avatar {
            width: 100%;
            height: 100%;
        }

        .avatar-container:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <iframe src="/resources/1_NLP_cleaning_and_preprocessing.pdf"></iframe>
    </div>

    <div class="avatar-container" id="chat-avatar">
        <img src="{{ url_for('static', filename='Avatar2.png') }}" alt="Avatar" class="avatar">
    </div>

    <audio id="intro-audio"></audio>
    <audio id="ai-response-audio"></audio>

    <audio id="start-sound" src="{{ url_for('static', filename='starting.mp3') }}"></audio>
    <audio id="stop-sound" src="{{ url_for('static', filename='closing.mp3') }}"></audio>



    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
    const avatar = document.getElementById("chat-avatar");
    const startSound = document.getElementById("start-sound");
    const stopSound = document.getElementById("stop-sound");
    const introAudio = document.getElementById("intro-audio");
    const aiAudio = document.getElementById("ai-response-audio");
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let currentPage = 1;  


    const conceptMapping = {
        2: "Text Extraction and Cleanup",
        10: "Character Encoding and Unicode Normalization",
        14: "Spelling Correction",
        25: "Tokenization",
        39: "Stop Word Removal",
        40: "Lowercasing, Punctuation, and Digit Removal",
        42: "Stemming and Lemmatization",
        51: "Text Normalization",
        55: "Part-of-Speech (POS) Tagging",
        59: "Named Entity Recognition (NER)",
        60: "Parsing and Syntactic Analysis",
        61: "Coreference Resolution"
    };


    function getConceptForPage(page) {
        let closestPage = Object.keys(conceptMapping)
            .map(Number)
            .reduce((prev, curr) => (curr <= page ? curr : prev), 2);
        return conceptMapping[closestPage] || "Unknown Concept";
    }

    function trackPDFPage() {
        const iframe = document.querySelector("iframe");
        if (!iframe) return;

        let pdfUrl = iframe.src;

        pdfjsLib.getDocument(pdfUrl).promise.then(pdfDoc => {
            let pdfViewer = iframe.contentWindow || iframe.contentDocument;

            pdfViewer.addEventListener("scroll", function () {
                let viewportHeight = pdfViewer.document.documentElement.clientHeight;
                let scrollTop = pdfViewer.document.documentElement.scrollTop;
                let pageHeight = viewportHeight;

                let newPage = Math.floor(scrollTop / pageHeight) + 1;
                if (newPage !== currentPage) {
                    currentPage = newPage;
                    console.log(`Current page: ${currentPage}`);
                }
            });
        }).catch(error => console.error("Error loading PDF:", error));
    }

    trackPDFPage();

    function playIntroAudio() {
        fetch("/get_intro_audio")
            .then(response => response.json())
            .then(data => {
                introAudio.src = data.intro_audio_url;
                introAudio.play().catch(() => {
                    console.log("Autoplay blocked, playing on user interaction...");
                    document.addEventListener("click", playIntroAudio, { once: true });
                });
            })
            .catch(error => console.error("Error loading intro audio:", error));
    }

    playIntroAudio();

    avatar.addEventListener("click", function () {
        if (!isRecording) {
            startRecording();
        } else {
            stopRecording();
        }
    });

    async function startRecording() {
        isRecording = true;
        audioChunks = [];

        startSound.play();

        let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
        mediaRecorder.start();
        console.log("Recording started...");
    }

    function stopRecording() {
        isRecording = false;
        mediaRecorder.stop();

        mediaRecorder.onstop = async () => {
            stopSound.play();

            const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
            const formData = new FormData();
            formData.append("audio", audioBlob, "user_audio.wav");

            let detectedConcept = getConceptForPage(currentPage);
            console.log(`üìñ Detected Concept: ${detectedConcept}`);
            formData.append("concept_name", detectedConcept);

            fetch("/submit_message", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log("üìù Server Response:", data);

                if (data.ai_audio_url) {
                    aiAudio.src = data.ai_audio_url;
                    aiAudio.play().catch(error => console.error("Playback failed:", error));
                } else {
                    console.error("‚ùå AI audio URL missing from response!");
                }
            })
            .catch(error => console.error("‚ùå Error sending audio:", error));
        };
    }
});

</script>
</body>
</html>